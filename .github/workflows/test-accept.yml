# Copyright 2022 The Magma Authors.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 0test-accept

on:
  repository_dispatch:
    types: [build-all-artifact]

jobs:
  test-magma-deb:
    runs-on: macos-12
    steps:
      - name: Print Client Payload
        run: |
          echo ${{ github.event.client_payload.artifact }}
      - uses: actions/setup-python@7f80679172b057fc5e90d70d197929d454754a5a # pin@v2
        with:
          python-version: '3.8.10'
      - name: Install pre requisites
        run: |
          pip3 install --upgrade pip
          pip3 install ansible fabric3 jsonpickle requests PyYAML
          vagrant plugin install vagrant-vbguest vagrant-disksize vagrant-reload
      - name: Open up network interfaces for VM
        run: |
          sudo mkdir -p /etc/vbox/
          echo '* 192.168.0.0/16' | sudo tee /etc/vbox/networks.conf 
          echo '* 3001::/64' | sudo tee -a /etc/vbox/networks.conf
      - name: Run Magma Deb Installation
        env:
          MAGMA_DEV_CPUS: 3
          MAGMA_DEV_MEMORY_MB: 9216
          MAGMA_PACKAGE: ${{ github.event.client_payload.artifact }}
        run: |
          cd lte/gateway/test
          fab integ_test_deb_installation
