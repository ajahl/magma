# Copyright 2022 The Magma Authors.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: build-all

on:
  workflow_dispatch: null
  push:
    branches:
      - master
      - 'v1.*'
  pull_request:
    branches:
      - master
      - 'v1.*'
    types: [ opened, reopened, synchronize ]

jobs:
  agw-build:
    runs-on: macos-12
    outputs:
      artifacts: ${{ steps.publish_packages.outputs.artifacts }}
    steps:
      - uses: actions/checkout@7884fcad6b5d53d10323aee724dc68d8b9096a2e # pin@v2
        with:
          fetch-depth: 0
      - name: Cache magma-dev-box
        uses: actions/cache@0865c47f36e68161719c5b124609996bb5c40129 # pin@v3
        with:
          path: ~/.vagrant.d/boxes/magmacore-VAGRANTSLASH-magma_dev
          key: vagrant-box-magma-dev-v1.2.20220801
      - name: Log in to vagrant cloud
        run: |
          if [[ -n "${{ secrets.VAGRANT_TOKEN }}" ]]
          then
            echo "Logging in to vagrant cloud to mitigate rate limiting."
            vagrant cloud auth login --token "${{ secrets.VAGRANT_TOKEN }}"
          else
            echo "Vagrant cloud token is not configured. Skipping login."
          fi
      - uses: actions/setup-python@7f80679172b057fc5e90d70d197929d454754a5a # pin@v2
        with:
          python-version: '3.8.10'
      - name: Install pre requisites
        run: |
          pip3 install --upgrade pip
          pip3 install ansible fabric3 jsonpickle requests PyYAML
          vagrant plugin install vagrant-disksize vagrant-vbguest vagrant-mutate vagrant-reload
      - name: Open up network interfaces for VM
        run: |
          sudo mkdir -p /etc/vbox/
          sudo touch /etc/vbox/networks.conf
          sudo sh -c "echo '* 192.168.0.0/16' > /etc/vbox/networks.conf"
          sudo sh -c "echo '* 3001::/64' >> /etc/vbox/networks.conf"
      - name: Build AGW
        run: |
          export MAGMA_DEV_MEMORY_MB=4096
          cd lte/gateway
          fab release package:destroy_vm=True
          mkdir magma-packages
          vagrant ssh -c "cp -r magma-packages /vagrant"
      - name: Publish debian packages
        id: publish_packages
        if: github.event_name == 'push'
        env:
          ARTIFACT: ''
        run: |
          cd lte/gateway/magma-packages
          ARTIFACTS='{"packages":[],"valid":false}'
          PUBLISH_ERROR="false"
          for i in `ls -a1 *.deb`
          do
            echo "#############################################"  
            echo "Pushing package: $i"
            echo "#############################################"
            if [grep -o '^magma_\d*.\d*.\d*-\d*-\d*' $i]; then
              ARTIFACT=$i
              JSON=${{ toJSON($i) }}
              echo $JSON
              break
            fi
          done
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: ajahl/magma
          event-type: build-all-artifact
          client-payload: '{ "artifact": "${{ ARTIFACT }}" }'
