# Copyright 2022 The Magma Authors.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# TESTS

name: 0test-dispatch

on:
  pull_request:
    types: [opened,reopened,synchronize]

jobs:
  agw-build:
    runs-on: macos-12
    steps:
      - uses: actions/checkout@7884fcad6b5d53d10323aee724dc68d8b9096a2e # pin@v2
      - name: Publish debian packages
        id: publish_packages
        run: |
          touch magma-sctpd_1.8.0-1663241096-1212843f_amd64.deb
          touch magma_1.8.0-1663241096-1212843f_amd64.deb
          touch td-agent-bit_1.6.9_amd64.deb
          for i in `ls -a1 magma_*.deb`
          do
            version_pin=${i#magma_}
            version_pin=${version_pin%_[a-z0-9]*.deb}
            version_pin='magma='${version_pin}
            echo "::set-output name=artifact::${version_pin}"
            echo "#############################################"  
            echo "Pushing package: ${version_pin}"
            echo "#############################################"
          done
      - name: Trigger integ workflow
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: ajahl/magma
          event-type: build-all-artifact
          client-payload: '{ "artifact": "${{ steps.publish_packages.outputs.artifact }}" }'
